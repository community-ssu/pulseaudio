From 68fad27e666cd8ecb17f737c05220e6b14ed22ce Mon Sep 17 00:00:00 2001
From: Jyri Sarha <jyri.sarha@nokia.com>
Date: Mon, 20 Jul 2009 11:48:53 +0300
Subject: [PATCH] alsa-old: Take sync volume patch into use.

---
 src/modules/alsa/module-alsa-sink-old.c |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)

diff --git a/src/modules/alsa/module-alsa-sink-old.c b/src/modules/alsa/module-alsa-sink-old.c
index 3d23419..4475097 100644
--- a/src/modules/alsa/module-alsa-sink-old.c
+++ b/src/modules/alsa/module-alsa-sink-old.c
@@ -679,6 +679,15 @@ static void thread_func(void *userdata) {
             }
         }
 
+        if (u->sink->flags & PA_SINK_SYNC_VOLUME) {
+            pa_usec_t volume_sleep;
+            pa_sink_volume_change_apply(u->sink, &volume_sleep);
+            if (volume_sleep > 0)
+                pa_rtpoll_set_timer_relative(u->rtpoll, volume_sleep);
+            else
+                pa_rtpoll_set_timer_disabled(u->rtpoll);
+        }
+
         /* Hmm, nothing to do. Let's sleep */
         if ((ret = pa_rtpoll_run(u->rtpoll, 1)) < 0)
             goto fail;
@@ -1018,6 +1027,9 @@ int pa__init(pa_module*m) {
     pa_sink_set_asyncmsgq(u->sink, u->thread_mq.inq);
     pa_sink_set_rtpoll(u->sink, u->rtpoll);
 
+    u->sink->thread_info.volume_change_safety_margin = 6000;
+    u->sink->thread_info.volume_change_extra_delay = 6000;
+
     u->frame_size = frame_size;
     u->fragment_size = frag_size = period_size * frame_size;
     u->nfragments = nfrags;
-- 
1.5.6.3

