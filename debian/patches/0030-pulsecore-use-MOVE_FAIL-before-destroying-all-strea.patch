From a3456cff1ff9bd9f902a5a9bf20dcf3219caaee7 Mon Sep 17 00:00:00 2001
From: =?utf-8?q?Marc-Andr=C3=A9=20Lureau?= <marc-andre.lureau@nokia.com>
Date: Mon, 16 Mar 2009 20:03:33 +0200
Subject: [PATCH 30/37] pulsecore: use MOVE_FAIL before destroying all streams

---
 src/pulsecore/sink.c   |    9 +++------
 src/pulsecore/source.c |    9 +++------
 2 files changed, 6 insertions(+), 12 deletions(-)

diff --git a/src/pulsecore/sink.c b/src/pulsecore/sink.c
index ff8700c..cbf629e 100644
--- a/src/pulsecore/sink.c
+++ b/src/pulsecore/sink.c
@@ -371,7 +371,7 @@ void pa_sink_put(pa_sink* s) {
 /* Called from main context */
 void pa_sink_unlink(pa_sink* s) {
     pa_bool_t linked;
-    pa_sink_input *i, *j = NULL;
+    pa_queue *q;
 
     pa_assert(s);
 
@@ -395,11 +395,8 @@ void pa_sink_unlink(pa_sink* s) {
     if (s->card)
         pa_idxset_remove_by_data(s->card->sinks, s, NULL);
 
-    while ((i = pa_idxset_first(s->inputs, NULL))) {
-        pa_assert(i != j);
-        pa_sink_input_kill(i);
-        j = i;
-    }
+    q = pa_sink_move_all_start(s);
+    pa_sink_move_all_fail(q);
 
     if (linked)
         sink_set_state(s, PA_SINK_UNLINKED);
diff --git a/src/pulsecore/source.c b/src/pulsecore/source.c
index cc6dfc4..fce7d55 100644
--- a/src/pulsecore/source.c
+++ b/src/pulsecore/source.c
@@ -324,7 +324,7 @@ void pa_source_put(pa_source *s) {
 /* Called from main context */
 void pa_source_unlink(pa_source *s) {
     pa_bool_t linked;
-    pa_source_output *o, *j = NULL;
+    pa_queue *q;
 
     pa_assert(s);
 
@@ -343,11 +343,8 @@ void pa_source_unlink(pa_source *s) {
     if (s->card)
         pa_idxset_remove_by_data(s->card->sources, s, NULL);
 
-    while ((o = pa_idxset_first(s->outputs, NULL))) {
-        pa_assert(o != j);
-        pa_source_output_kill(o);
-        j = o;
-    }
+    q = pa_source_move_all_start(s);
+    pa_source_move_all_fail(q);
 
     if (linked)
         source_set_state(s, PA_SOURCE_UNLINKED);
-- 
1.6.2.rc1.13.gfd76c.dirty

