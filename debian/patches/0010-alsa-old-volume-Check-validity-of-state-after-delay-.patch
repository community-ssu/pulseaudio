From 7920a6c2023a0a1ec21c318ec9719bb342c958d0 Mon Sep 17 00:00:00 2001
From: Jyri Sarha <jyri.sarha@nokia.com>
Date: Mon, 8 Jun 2009 15:51:55 +0300
Subject: [PATCH 10/68] alsa-old: volume: Check validity of state after delay timer expiration.

---
 src/modules/alsa/module-alsa-sink-volume.c |   32 +++++++++++++++++++++++----
 1 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/src/modules/alsa/module-alsa-sink-volume.c b/src/modules/alsa/module-alsa-sink-volume.c
index 163022b..ad7e2e0 100644
--- a/src/modules/alsa/module-alsa-sink-volume.c
+++ b/src/modules/alsa/module-alsa-sink-volume.c
@@ -563,6 +563,26 @@ static void set_alsa_mixer_volume_timer_cb(pa_mainloop_api *a, pa_time_event *e,
     if (u->active_mixer != u->delayed_mixer_ctrl.m)
         pa_log_warn("Active mixer has changed during compensation delay.");
 
+    if (!u->sink) {
+        pa_log_debug("This sink does not exist any more, go away.");
+        return;
+    }
+
+    if (!u->active_mixer) {
+        pa_log_warn("%s: no active mixer (sink_set_volume_cb)", u->device_name);
+        return;
+    }
+
+    if (!u->active_mixer->tuning_data[u->active_tuning].tuning_table_filled) {
+        load_mixer_tuning(u, u->active_mixer, u->active_tuning);
+        if (!u->active_mixer->tuning_data[u->active_tuning].tuning_table_filled) {
+            pa_log_info("No tuning table %d filled for %s mixer", u->active_tuning, u->active_mixer->name);
+            fill_mixer_tuning(u, u->active_mixer, u->active_tuning);
+        }
+    }
+
+    log_spam("set volume to active mixer %s", u->active_mixer->name);
+
     set_alsa_mixer_volumes(u, u->delayed_mixer_ctrl.m, u->delayed_mixer_ctrl.vv);
 }
 
@@ -625,15 +645,17 @@ static void sink_set_volume_cb(pa_sink *s) {
     pa_assert(u);
     pa_assert(u->active_mixer);
 
+    if (s != u->sink) {
+        pa_log_debug("This in not my sink, what to do?");
+    }
+
+    /* These checks are probably unnecessary here because they are done again after timer
+       expiration, but I do not dare to remove them just yet. */
     if (!u->sink) {
         pa_log_debug("This sink does not exist any more, go away.");
         return;
     }
 
-    if (s != u->sink) {
-        pa_log_debug("This in not my sink, what to do?");
-    }
-
     if (!u->active_mixer) {
         pa_log_warn("%s: no active mixer (sink_set_volume_cb)", u->device_name);
         return;
@@ -642,7 +664,7 @@ static void sink_set_volume_cb(pa_sink *s) {
     if (u->active_mixer->slaves) {
         pa_log_error("SET SLAVE VOLUMES NOT IMPLEMENTED");
     }
-
+    
     if (!u->active_mixer->tuning_data[u->active_tuning].tuning_table_filled) {
         load_mixer_tuning(u, u->active_mixer, u->active_tuning);
         if (!u->active_mixer->tuning_data[u->active_tuning].tuning_table_filled) {
-- 
1.6.3.1

