From 7fb878a47ad8dcfadb22fa9cdd8dac5c80aaacb6 Mon Sep 17 00:00:00 2001
From: =?utf-8?q?Marc-Andr=C3=A9=20Lureau?= <marc-andre.lureau@nokia.com>
Date: Mon, 2 Mar 2009 18:52:36 +0200
Subject: [PATCH 24/26] pulsecore: hack a test for loop usage

---
 src/pulse/mainloop.c |   20 ++++++++++++++++++++
 1 files changed, 20 insertions(+), 0 deletions(-)

diff --git a/src/pulse/mainloop.c b/src/pulse/mainloop.c
index 60e5d1f..7726237 100644
--- a/src/pulse/mainloop.c
+++ b/src/pulse/mainloop.c
@@ -52,6 +52,7 @@
 #include <pulsecore/core-error.h>
 #include <pulsecore/winsock.h>
 #include <pulsecore/macro.h>
+#include <pulsecore/once.h>
 
 #include "mainloop.h"
 
@@ -920,6 +921,25 @@ int pa_mainloop_iterate(pa_mainloop *m, int block, int *retval) {
     if ((r = pa_mainloop_prepare(m, block ? -1 : 0)) < 0)
         goto quit;
 
+#if 1
+    {
+        static struct timeval start;
+        static struct timeval now;
+        static int hz = 0;
+
+        ++hz;
+
+        PA_ONCE_BEGIN {
+            pa_gettimeofday(&start);
+        } PA_ONCE_END;
+
+        if (pa_timeval_diff(pa_gettimeofday(&now), &start) >= PA_USEC_PER_SEC) {
+            pa_log_debug("Before poll(): %d nfds, %d Hz", m->n_pollfds, hz);
+            hz = 0;
+            pa_gettimeofday(&start);
+        }
+    }
+#endif
     if ((r = pa_mainloop_poll(m)) < 0)
         goto quit;
 
-- 
1.6.2.rc1.13.gfd76c.dirty

