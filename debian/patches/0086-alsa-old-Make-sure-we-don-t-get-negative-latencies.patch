From 778b2c35b7e70910a67d7e38a1150782bf2d2d78 Mon Sep 17 00:00:00 2001
From: Jyri Sarha <jyri.sarha@nokia.com>
Date: Fri, 31 Jul 2009 15:45:17 +0300
Subject: [PATCH] alsa-old: Make sure we don't get negative latencies

---
 src/modules/alsa/module-alsa-sink-old.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/src/modules/alsa/module-alsa-sink-old.c b/src/modules/alsa/module-alsa-sink-old.c
index 4475097..b3c7bbe 100644
--- a/src/modules/alsa/module-alsa-sink-old.c
+++ b/src/modules/alsa/module-alsa-sink-old.c
@@ -394,6 +394,10 @@ static int sink_get_latency_by_timestamps(struct userdata *u, pa_usec_t *d) {
                                 avail * u->frame_size, &u->sink->sample_spec);
     elapsed = pa_rtclock_now() - pa_timespec_load(&ts_dma);
 
+    /* Make sure the latency values does not roll over */
+    if (elapsed > buffered)
+        return -1;
+
     *d = buffered - elapsed;
 
 #if 0
-- 
1.5.6.3

